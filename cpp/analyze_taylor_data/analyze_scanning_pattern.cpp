#include <iostream>
#include <iomanip>
#include <tuple>
#include <ctime>

#include <lidar_sim/SectionLoader.h>
#include <lidar_sim/RayDirnServer.h>
#include <lidar_sim/PoseServer.h>
#include <lidar_sim/ModelingUtils.h>
#include <lidar_sim/LaserCalibParams.h>
#include <lidar_sim/LaserUtils.h>
#include <lidar_sim/VizUtils.h>

using namespace lidar_sim;

std::string genRelPathSection(int section_id)
{
    std::ostringstream ss;
    ss << "data/sections/section_" << std::setw(2) << std::setfill('0') << section_id 
       << "/section_" << std::setw(2) << std::setfill('0') << section_id 
       << "_world_frame_subsampled.xyz";

    return ss.str();
}

int main(int argc, char **argv)
{
    clock_t start_time = clock();

    std::vector<double> ray_origin{0, 0, 0};
    std::vector<std::vector<double> > packet_pts{
	{-0.7916,2.6055,-1.615},
	{-0.8003,2.6342,-0.4523},
	{-0.8161,2.686,-1.5773},
	{-0.8124,2.6739,-0.3927},
	{-0.9788,3.2216,-0.3938},
	{-0.8375,2.7566,-1.4471},
	{-0.7468,2.4579,-0.2397},
	{-0.6311,2.0773,-1.0277},
	{-0.7952,2.6172,-0.1913},
	{-0.6857,2.2569,-1.0502},
	{-0.7811,2.571,-0.1253},
	{-0.801,2.6363,-1.1509},
	{-0.8457,2.7836,-0.0675},
	{-0.8248,2.7148,-1.1079},
	{-0.8105,2.6676,0},
	{-0.7916,2.6056,-0.9912},
	{-0.8353,2.7491,0.0667},
	{-0.7849,2.5834,-0.9123},
	{-0.8119,2.6723,0.1302},
	{-0.8414,2.7694,-0.9032},
	{-0.8491,2.7947,0.2042},
	{-0.8724,2.8715,-0.8605},
	{-0.7821,2.5741,0.251},
	{-0.892,2.9361,-0.8033},
	{-0.8447,2.7801,-0.6884},
	{-0.8256,2.7174,0.3991},
	{-0.811,2.6692,-0.593},
	{-0.8313,2.7362,0.4698},
	{-0.9039,2.975,-0.5858},
	{-0.7982,2.6271,0.5173},
	{-0.765,2.5417,-1.5741},
	{-0.7872,2.6155,-0.4487},
	{-0.8115,2.6965,-1.5822},
	{-0.7922,2.6323,-0.3863},
	{-0.8168,2.714,-1.507},
	{-0.9624,3.1976,-0.3905},
	{-0.8262,2.7451,-1.4399},
	{-0.7421,2.4656,-0.2402},
	{-0.6267,2.0824,-1.0294},
	{-0.7716,2.5639,-0.1872},
	{-0.7773,2.5826,-0.1258},
	{-0.7739,2.5712,-1.1216},
	{-0.8868,2.9466,-0.0714},
	{-0.8277,2.7501,0},
	{-0.7648,2.5411,-0.9659},
	{-0.8275,2.7494,0.0667},
	{-0.7841,2.6054,-0.9194},
	{-0.8043,2.6725,0.1302},
	{-0.8319,2.7642,-0.9008},
	{-0.8337,2.7702,0.2023},
	{-0.8472,2.8148,-0.8429},
	{-0.7759,2.5781,0.2512},
	{-0.8805,2.9254,-0.7998},
	{-0.8255,2.7429,0.335},
	{-0.8419,2.7972,-0.6921},
	{-0.8185,2.7196,0.3991},
	{-0.8051,2.6751,-0.5938},
	{-0.8247,2.7402,0.4701},
	{-0.8933,2.968,-0.584},
	{-0.793,2.6348,0.5184},
	{-0.7531,2.5309,-1.566},
	{-0.7761,2.6085,-0.4471},
	{-0.8031,2.699,-1.5822},
	{-0.7834,2.6329,-0.3861},
	{-0.8043,2.703,-1.4995},
	{-0.9591,3.2234,-0.3933},
	{-0.816,2.7425,-1.4372},
	{-0.7337,2.466,-0.24},
	{-0.6238,2.0965,-1.0354},
	{-0.7579,2.5471,-0.1858},
	{-0.7686,2.5832,-0.1257},
	{-0.6595,2.2164,-0.9659},
	{-0.8787,2.9532,-0.0715},
	{-0.6939,2.332,-0.9501},
	{-0.8396,2.8217,0},
	{-0.7471,2.5111,-0.9536},
	{-0.8166,2.7443,0.0665},
	{-0.7743,2.6024,-0.9175},
	{-0.7988,2.6846,0.1306},
	{-0.7917,2.6607,-0.8662},
	{-0.8626,2.899,0.2115},
	{-0.829,2.7861,-0.8335},
	{-0.7678,2.5805,0.2512},
	{-0.8757,2.943,-0.8038},
	{-0.8186,2.7512,0.3357},
	{-0.8597,2.8893,-0.7143},
	{-0.8218,2.762,0.405},
	{-0.7978,2.6813,-0.5946},
	{-0.8144,2.7371,0.4692},
	{-0.8447,2.8389,-0.558},
	{-0.7679,2.5808,0.5073},
	{-0.746,2.533,-1.566},
	{-0.7839,2.6618,-0.4559},
	{-0.7975,2.7079,-1.5861},
	{-0.7833,2.6598,-0.3897},
	{-0.7952,2.7002,-1.4967},
	{-0.9742,3.308,-0.4033},
	{-0.7942,2.6968,-1.4121},
	{-0.7302,2.4795,-0.2411},
	{-0.6425,2.1815,-1.0764},
	{-0.7547,2.5627,-0.1868},
	{-0.6633,2.2522,-1.0453},
	{-0.7738,2.6274,-0.1277},
	{-0.6512,2.2111,-0.9628},
	{-0.8479,2.8789,-0.0697},
	{-0.7216,2.4501,-0.9974},
	{-0.8317,2.8241,0},
	{-0.7412,2.5167,-0.9549},
	{-0.8219,2.7907,0.0675},
	{-0.7941,2.6964,0.1311},
	{-0.7756,2.6336,-0.8567},
	{-0.8567,2.9091,0.2121},
	{-0.8174,2.7755,-0.8297},
	{-0.9147,3.106,0.3021},
	{-0.88,2.9881,-0.8155},
	{-0.8081,2.744,0.3345},
	{-0.839,2.8488,-0.7037},
	{-0.8113,2.7548,0.4036},
	{-0.8014,2.7211,-0.6029},
	{-0.8062,2.7375,0.4689},
	{-0.7923,2.6904,-0.5284},
	{-0.779,2.6452,0.5195},
	{-0.7375,2.5301,-1.5629},
	{-0.7864,2.6981,-0.4617},
	{-0.7909,2.7135,-1.5881},
	{-0.7875,2.7019,-0.3955},
	{-0.7921,2.7176,-1.5051},
	{-0.8416,2.8874,-0.3517},
	{-0.7244,2.4853,-0.2415},
	{-0.6379,2.1885,-1.079},
	{-0.7453,2.5571,-0.1862},
	{-0.6534,2.2417,-1.0396},
	{-0.7743,2.6565,-0.129},
	{-0.644,2.2094,-0.9612},
	{-0.8381,2.8755,-0.0695},
	{-0.7856,2.6954,-1.0963},
	{-0.8238,2.8264,0},
	{-0.7557,2.5928,-0.983},
	{-0.8303,2.8487,0.0689},
	{-0.7624,2.6158,-0.9207},
	{-0.8017,2.7504,0.1336},
	{-0.7688,2.6376,-0.8573},
	{-0.8542,2.9306,0.2135},
	{-0.8059,2.7649,-0.8258},
	{-0.9094,3.1201,0.3032},
	{-0.8679,2.9776,-0.8119},
	{-0.7927,2.7195,0.3313},
	{-0.8082,2.7727,-0.6843},
	{-0.7964,2.7323,0.4},
	{-0.7806,2.6782,-0.593},
	{-0.8063,2.7663,0.4734},
	{-0.7848,2.6926,-0.5284},
	{-0.7738,2.6549,0.521},
	{-0.7328,2.5422,-1.569},
	{-0.838,2.9071,-0.4971},
	{-0.7848,2.7225,-1.592},
	{-0.8344,2.8945,-0.4234},
	{-0.7811,2.7098,-1.4995},
	{-0.6401,2.2205,-1.1607},
	{-0.7154,2.4817,-0.241},
	{-0.6374,2.2112,-1.0893},
	{-0.7366,2.5555,-0.186},
	{-0.6149,2.1331,-0.9884},
	{-0.7708,2.6741,-0.1298},
	{-0.6384,2.2148,-0.9628},
	{-0.8446,2.9299,-0.0708},
	{-0.8193,2.8423,0},
	{-0.7663,2.6582,-1.0069},
	{-0.8152,2.8281,0.0683},
	{-0.7541,2.6162,-0.92},
	{-0.7891,2.7374,0.1329},
	{-0.7636,2.649,-0.8603},
	{-0.8449,2.9312,0.2133},
	{-0.7769,2.6952,-0.8043},
	{-0.8553,2.9671,-0.8084},
	{-0.7896,2.739,0.3334},
	{-0.7978,2.7676,-0.6825},
	{-0.7877,2.7328,0.3997},
	{-0.777,2.6956,-0.5963},
	{-0.8041,2.7895,0.477},
	{-0.7747,2.6874,-0.5269},
	{-0.7719,2.6779,0.5251},
	{-0.7262,2.5477,-1.5711},
	{-0.7617,2.6723,-0.4565},
	{-0.7695,2.6997,-1.5773},
	{-0.7753,2.7199,-0.3975},
	{-0.7682,2.6951,-1.4901},
	{-0.633,2.2206,-1.1598},
	{-0.7107,2.4934,-0.2419},
	{-0.612,2.147,-1.0567},
	{-0.7279,2.5538,-0.1857},
	{-0.5915,2.0751,-0.9607},
	{-0.764,2.6802,-0.13},
	{-0.6298,2.2096,-0.9597},
	{-0.809,2.8382,-0.0685},
	{-0.8076,2.8331,0},
	{-0.7635,2.6786,-1.0137},
	{-0.7909,2.7747,0.067},
	{-0.923,3.238,-1.1377},
	{-0.7777,2.7282,0.1323},
	{-0.761,2.6697,-0.8662},
	{-0.8712,3.0565,0.2222},
	{-0.7636,2.679,-0.7988},
	{-2.0296,7.1202,0.6907},
	{-0.7781,2.7296,-0.743},
	{-0.7831,2.7471,0.334},
	{-0.7896,2.7699,-0.6825},
	{-0.7758,2.7218,0.3978},
	{-0.911,3.1961,0.546},
	{-0.7737,2.7142,-0.5318},
	{-0.7107,2.5181,-1.5517},
	{-0.7563,2.68,-0.4575},
	{-0.7573,2.6832,-1.5665},
	{-0.7499,2.6571,-0.388},
	{-0.7063,2.5025,-0.3041},
	{-0.6315,2.2378,-1.1679},
	{-0.7091,2.5125,-0.2436},
	{-0.598,2.119,-1.0422},
	{-0.7196,2.5499,-0.1853},
	{-0.5876,2.082,-0.9632},
	{-0.7678,2.7207,-0.1318},
	{-0.6236,2.2095,-0.9589},
	{-0.7929,2.8095,-0.0678},
	{-0.6118,2.1677,-0.8795},
	{-0.8023,2.843,0},
	{-0.7585,2.6878,-1.0165},
	{-0.7608,2.6959,0.065},
	{-0.7754,2.7476,0.1331},
	{-0.7607,2.6955,-0.874},
	{-0.8426,2.9858,0.2169},
	{-0.7775,2.755,-0.8208},
	{-0.8816,3.1239,0.3028},
	{-0.7625,2.7019,-0.7349},
	{-0.7937,2.8122,0.3417},
	{-0.7807,2.7664,-0.6811},
	{-0.7644,2.7085,0.3955},
	{-0.8204,2.907,-0.642},
	{-0.7538,2.6708,-0.5229},
	{-0.7013,2.5136,-1.5476},
	{-0.751,2.6917,-0.4591},
	{-0.7554,2.7073,-1.5792},
	{-0.7409,2.6555,-0.3875},
	{-0.6876,2.4644,-0.2992},
	{-0.6441,2.3085,-1.2038},
	{-0.7139,2.5587,-0.2478},
	{-0.5913,2.1191,-1.0413},
	{-0.7201,2.5809,-0.1874},
	{-0.5809,2.0819,-0.9623},
	{-0.7452,2.671,-0.1293},
	{-0.6165,2.2095,-0.9582},
	{-0.7991,2.8638,-0.069},
	{-0.6068,2.1749,-0.8817},
	{-0.7901,2.8318,0},
	{-0.7329,2.6267,-0.9925},
	{-0.7523,2.6963,0.065},
	{-0.7737,2.773,0.1343},
	{-0.7527,2.6978,-0.874},
	{-0.829,2.971,0.2157},
	{-0.7595,2.7221,-0.8104},
	{-0.754,2.7022,-0.7344},
	{-0.7789,2.7916,0.3389},
	{-0.7568,2.7124,-0.6672},
	{-0.7686,2.7547,0.4019},
	{-0.8081,2.8962,-0.6391},
	{-0.74,2.6522,-0.5188},
	{-0.7184,2.5746,0.5036},
	{-0.6966,2.5256,-1.5537},
	{-0.7483,2.713,-0.4624},
	{-0.7492,2.7163,-1.5832},
	{-0.7299,2.6462,-0.3858},
	{-0.6824,2.4741,-0.3001},
	{-0.6239,2.2621,-1.1787},
	{-0.7111,2.5781,-0.2495},
	{-0.5864,2.126,-1.0439},
	{-0.7342,2.6619,-0.1931},
	{-0.5728,2.0766,-0.9591},
	{-0.7224,2.6192,-0.1267},
	{-0.5987,2.1704,-0.9404},
	{-0.7937,2.8777,-0.0693},
	{-0.7227,2.6203,-1.0614},
	{-0.7823,2.8361,0},
	{-0.7815,2.8334,0.0682},
	{-0.7655,2.7752,0.1343},
	{-0.7442,2.6981,-0.8734},
	{-0.8244,2.9888,0.2168},
	{-0.708,2.5668,-0.7635},
	{-0.7895,2.8622,0.277},
	{-0.7465,2.7063,-0.7349},
	{-0.7648,2.7729,0.3364},
	{-0.7405,2.6846,-0.6599},
	{-0.7552,2.7379,0.3991},
	{-0.8005,2.9024,-0.64},
	{-0.7856,2.848,0.4854},
	{-0.7311,2.6506,-0.5181},
	{-0.729,2.6431,0.5166},
	{-0.6941,2.5441,-1.5639},
	{-0.7319,2.6827,-0.4569},
	{-0.7467,2.7369,-1.5939},
	{-0.7194,2.6368,-0.3841},
	{-0.7232,2.6509,-1.461},
	{-0.6766,2.4799,-0.3006},
	{-0.6092,2.2328,-1.1625},
	{-0.6976,2.557,-0.2473},
	{-0.5966,2.187,-1.073},
	{-0.7268,2.6639,-0.1931},
	{-0.566,2.0747,-0.9575},
	{-0.7125,2.6116,-0.1262},
	{-0.5877,2.1543,-0.9327},
	{-0.7704,2.824,-0.068},
	{-0.7316,2.6816,-1.0854},
	{-0.7785,2.8537,0},
	{-0.6539,2.3969,-0.9043},
	{-0.7599,2.7854,0.067},
	{-0.764,2.8005,0.1354},
	{-0.7512,2.7536,-0.8906},
	{-0.8008,2.9353,0.2128},
	{-0.5885,2.1571,-0.6411},
	{-0.8433,3.0911,0.2989},
	{-0.7404,2.714,-0.7365},
	{-0.7612,2.7903,0.3382},
	{-0.7304,2.6773,-0.6576},
	{-0.7496,2.7476,0.4003},
	{-0.8259,3.0273,-0.667},
	{-0.7433,2.7246,0.464},
	{-0.7465,2.7361,-0.5343},
	{-0.7315,2.6811,0.5236},
	{-0.6803,2.5229,-1.5497},
	{-0.728,2.7001,-0.4594},
	{-0.7354,2.7273,-1.5871},
	{-0.7141,2.6485,-0.3855},
	{-0.6776,2.5132,-1.384},
	{-0.7338,2.7216,-0.3296},
	{-0.5988,2.2208,-1.1553},
	{-0.6942,2.5745,-0.2488},
	{-0.6024,2.2341,-1.0952},
	{-0.7095,2.6314,-0.1906},
	{-0.5598,2.0763,-0.9575},
	{-0.7073,2.6234,-0.1267},
	{-0.5823,2.1596,-0.9343},
	{-0.7693,2.8533,-0.0686},
	{-0.7675,2.8463,0},
	{-0.6669,2.4733,-0.9323},
	{-0.7938,2.944,0.0708},
	{-0.7049,2.6142,-0.9149},
	{-0.777,2.8818,0.1392},
	{-0.6695,2.483,-0.8025},
	{-0.8056,2.9877,0.2164},
	{-0.5846,2.1681,-0.6439},
	{-0.812,3.0114,-0.8165},
	{-0.7561,2.8041,0.3396},
	{-0.7245,2.687,-0.6594},
	{-0.7574,2.8091,0.4089},
	{-0.8098,3.0033,-0.6612},
	{-0.7368,2.7325,0.465},
	{-0.7455,2.7649,0.5395}};
    
    RayDirnServer ray_dirn_server;

    std::vector<double> unrolled_yaws;
    std::vector<double> unrolled_pitches;
    std::vector<std::vector<double> > unrolled_pts;
    std::vector<int> unrolled_hit_flag;
    std::tie(unrolled_pitches, unrolled_yaws, unrolled_pts, unrolled_hit_flag)
	= ray_dirn_server.fitDetailToPts(ray_origin, packet_pts);

    std::cout << "unrolled pitches: " << std::endl;
    dispVec(unrolled_pitches);
    std::cout << "unrolled yaws: " << std::endl;
    dispVec(unrolled_yaws);
    std::cout << "unrolled pts: " << std::endl;
    dispMat(unrolled_pts);
    std::cout << "unrolled hit flag: " << std::endl;
    dispVec(unrolled_hit_flag);

    double elapsed_time = (clock()-start_time)/CLOCKS_PER_SEC;
    std::cout << "elapsed time: " << elapsed_time << "s." << std::endl;
	
    return(1);
}
